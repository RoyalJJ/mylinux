
<!-- saved from url=(0073)http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CASE</title>
    
    <script type="text/javascript" src="./day03CASE_files/jquery.min.js">
    </script>
    <script type="text/javascript" src="./day03CASE_files/jquery.snippet.js">
    </script>
    <script type="text/javascript" src="./day03CASE_files/main.js">
    </script>
    <link type="text/css" href="./day03CASE_files/index.css" rel="Stylesheet">
    <link type="text/css" href="./day03CASE_files/jquery.snippet.css" rel="Stylesheet">
  </head>
  <body>
    <div class="source_style_case">
      <a name="page_top_case" id="top_anchor">
      </a><a id="link_top" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#page_top_case">Top</a>
      <h1>NSD DBA2 DAY03</h1>
      <ol class="index">
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#case1">案例1：配置MySQL多实例</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#case2">案例2：准备MHA集群环境</a>
        </li>
        <li>
          <a href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#case3">案例3：配置MHA集群环境</a>
        </li>
      </ol>
      <a name="case1">
      </a>
      <h2>1 案例1：配置MySQL多实例</h2>
      <h3>1.1 问题</h3>
      <ul class="list">
        <li>在主机192.168.4.56上，配置第1个MySQL实例
</li>
        <li>实例名称mysql1、端口3307
</li>
        <li>数据库目录/data3307、pid文件mysql1.pid
</li>
        <li>错误日志mysql1.err
</li>
        <li>在主机192.168.4.56上，配置第2个MySQL实例
</li>
        <li>实例名称mysql2、端口3308
</li>
        <li>数据库目录/data3308、pid文件mysql2.pid
</li>
        <li>错误日志mysql2.err
</li>
      </ul>
      <p class="number">步骤一：配置多实例（192.168.4.56上面操作）</p>
      <p>什么是多实例：</p>
      <p>在一台物理主机上运行多个数据库服务，可以节约运维成本，提高硬件利用率</p>
      <p>1）解压软件、修改目录名</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style=""><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql <span class="sh_symbol">~]</span># cd <span class="sh_normal">mysql</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># ls</li><li>mysql<span class="sh_number">-5.7.20</span><span class="sh_symbol">-</span>linux<span class="sh_symbol">-</span>glibc2<span class="sh_number">.12</span><span class="sh_symbol">-</span>x86_64<span class="sh_symbol">.</span>tar<span class="sh_symbol">.</span>gz</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># tar <span class="sh_symbol">-</span>xf mysql<span class="sh_number">-5.7.20</span><span class="sh_symbol">-</span>linux<span class="sh_symbol">-</span>glibc2<span class="sh_number">.12</span><span class="sh_symbol">-</span>x86_64<span class="sh_symbol">.</span>tar<span class="sh_symbol">.</span>gz</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mv mysql<span class="sh_number">-5.7.20</span><span class="sh_symbol">-</span>linux<span class="sh_symbol">-</span>glibc2<span class="sh_number">.12</span><span class="sh_symbol">-</span><span class="sh_normal">x86_64 </span><span class="sh_symbol">/</span><span class="sh_normal">usr</span><span class="sh_symbol">/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span>mysql</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql ~]# cd mysql/
[root@mysql mysql]# ls
mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz
[root@mysql mysql]# tar -xf mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz
[root@mysql mysql]# mv mysql-5.7.20-linux-glibc2.12-x86_64 /usr/local/mysql

</pre></div></div>
      <p>2）调整PATH变量</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># echo  <span class="sh_string">"export  PATH=/usr/local/mysql/bin:$PATH"</span> <span class="sh_symbol">\</span> </li><li> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_regexp">/etc/</span>profile</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># <span class="sh_normal">source </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>profile</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># echo $PATH</li><li><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">mysql</span><span class="sh_symbol">/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">mycat</span><span class="sh_symbol">/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">mycat</span><span class="sh_symbol">/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span>sbin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span>sbin<span class="sh_symbol">:</span><span class="sh_regexp">/usr/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/root/</span>bin<span class="sh_symbol">:</span><span class="sh_regexp">/root/</span>bin</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# echo  "export  PATH=/usr/local/mysql/bin:$PATH" \ 
 &gt;&gt; /etc/profile
[root@mysql mysql]# source /etc/profile
[root@mysql mysql]# echo $PATH
/usr/local/mysql/bin:/usr/local/mycat/bin:/usr/local/mycat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin
</pre></div></div>
      <p>3）编辑主配置文件/etc/my.cnf</p>
      <p>每个实例要有独立的数据库目录、监听端口号、实例名称和独立的sock文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>mysqld_multi<span class="sh_symbol">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//启用多实例</span></li><li>mysqld <span class="sh_symbol">=</span> <span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">mysql</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>mysqld_safe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//指定进程文件路径</span></li><li>mysqladmin <span class="sh_symbol">=</span> <span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span><span class="sh_normal">mysql</span><span class="sh_symbol">/</span><span class="sh_normal">bin</span><span class="sh_symbol">/</span>mysqladmin&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//指定管理命令路径</span></li><li>user <span class="sh_symbol">=</span> root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//指定进程用户</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>mysqld1<span class="sh_symbol">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//实例进程名称</span></li><li>port<span class="sh_symbol">=</span><span class="sh_number">3307</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//端口号</span></li><li>datadir<span class="sh_symbol">=</span><span class="sh_regexp">/data3307&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="sh_symbol">/</span>数据库目录 ，要手动创建</li><li>socket<span class="sh_symbol">=</span><span class="sh_regexp">/data3307/m</span>ysqld<span class="sh_symbol">.</span>sock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//指定sock文件的路径和名称</span></li><li>pid<span class="sh_symbol">-</span>file<span class="sh_symbol">=</span><span class="sh_regexp">/data3307/m</span>ysql1<span class="sh_symbol">.</span>pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//进程pid号文件位置</span></li><li>log<span class="sh_symbol">-</span>error<span class="sh_symbol">=</span><span class="sh_regexp">/data3307/m</span>ysql1<span class="sh_symbol">.</span>err&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//错误日志位置 </span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>mysqld2<span class="sh_symbol">]</span></li><li>port<span class="sh_symbol">=</span><span class="sh_number">3308</span></li><li>datadir<span class="sh_symbol">=/</span>data3308</li><li>socket<span class="sh_symbol">=</span><span class="sh_regexp">/data3308/m</span>ysqld<span class="sh_symbol">.</span>sock</li><li>pid<span class="sh_symbol">-</span>file<span class="sh_symbol">=</span><span class="sh_regexp">/data3308/m</span>ysql2<span class="sh_symbol">.</span>pid</li><li>log<span class="sh_symbol">-</span>error<span class="sh_symbol">=</span><span class="sh_regexp">/data3308/m</span>ysql2<span class="sh_symbol">.</span>err </li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[mysqld_multi]		//启用多实例
mysqld = /usr/local/mysql/bin/mysqld_safe		//指定进程文件路径
mysqladmin = /usr/local/mysql/bin/mysqladmin	//指定管理命令路径
user = root		//指定进程用户

[mysqld1]		//实例进程名称
port=3307		//端口号
datadir=/data3307		//数据库目录 ，要手动创建
socket=/data3307/mysqld.sock		//指定sock文件的路径和名称
pid-file=/data3307/mysql1.pid		//进程pid号文件位置
log-error=/data3307/mysql1.err		//错误日志位置 

[mysqld2]
port=3308
datadir=/data3308
socket=/data3308/mysqld.sock
pid-file=/data3308/mysql2.pid
log-error=/data3308/mysql2.err 

</pre></div></div>
      <p>4）创建数据库目录</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mkdir <span class="sh_symbol">-</span><span class="sh_normal">p </span><span class="sh_symbol">/</span>data3307</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mkdir <span class="sh_symbol">-</span><span class="sh_normal">p </span><span class="sh_symbol">/</span>data3308</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# mkdir -p /data3307
[root@mysql mysql]# mkdir -p /data3308
</pre></div></div>
      <p>5）创建进程运行的所有者和组 mysql</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># useradd mysql</li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># chown  mysql<span class="sh_symbol">:</span><span class="sh_normal">mysql  </span><span class="sh_symbol">/</span>data<span class="sh_symbol">*</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# useradd mysql
[root@mysql mysql]# chown  mysql:mysql  /data*
</pre></div></div>
      <p>6）初始化授权库</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysqld <span class="sh_symbol">--</span>user<span class="sh_symbol">=</span>mysql <span class="sh_symbol">--</span>basedir<span class="sh_symbol">=</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span>mysql </li><li><span class="sh_symbol">--</span>datadir<span class="sh_symbol">=/</span>data3307 <span class="sh_symbol">--</span>initialize</li><li><span class="sh_symbol">...</span></li><li><span class="sh_number">2018-09</span><span class="sh_symbol">-</span>26T07<span class="sh_symbol">:</span><span class="sh_number">07</span><span class="sh_symbol">:</span><span class="sh_number">33</span><span class="sh_symbol">.</span>443378Z <span class="sh_number">1</span> <span class="sh_symbol">[</span>Note<span class="sh_symbol">]</span> A temporary password is generated <span class="sh_keyword">for</span> root@localhost<span class="sh_symbol">:</span> <span class="sh_number">7L</span><span class="sh_symbol">?</span>Vi<span class="sh_symbol">!</span>dGKmgu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//root用户登录的初始化密码</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysqld <span class="sh_symbol">--</span>user<span class="sh_symbol">=</span>mysql <span class="sh_symbol">--</span>basedir<span class="sh_symbol">=</span><span class="sh_regexp">/usr/</span><span class="sh_normal">local</span><span class="sh_symbol">/</span>mysql</li><li> <span class="sh_symbol">--</span>datadir<span class="sh_symbol">=/</span>data3308 <span class="sh_symbol">--</span>initialize</li><li><span class="sh_symbol">...</span></li><li><span class="sh_number">2018-09</span><span class="sh_symbol">-</span>26T07<span class="sh_symbol">:</span><span class="sh_number">08</span><span class="sh_symbol">:</span><span class="sh_number">07</span><span class="sh_symbol">.</span>770289Z <span class="sh_number">1</span> <span class="sh_symbol">[</span>Note<span class="sh_symbol">]</span> A temporary password is generated <span class="sh_keyword">for</span> root@localhost<span class="sh_symbol">:</span> kC<span class="sh_symbol">)</span>BbyUp1a<span class="sh_symbol">-</span>b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//root用户登录的初始化密码</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# mysqld --user=mysql --basedir=/usr/local/mysql 
--datadir=/data3307 --initialize
...
2018-09-26T07:07:33.443378Z 1 [Note] A temporary password is generated for root@localhost: 7L?Vi!dGKmgu		//root用户登录的初始化密码
[root@mysql mysql]# mysqld --user=mysql --basedir=/usr/local/mysql
 --datadir=/data3308 --initialize
...
2018-09-26T07:08:07.770289Z 1 [Note] A temporary password is generated for root@localhost: kC)BbyUp1a-b		//root用户登录的初始化密码
</pre></div></div>
      <p>7）启动多实例</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysqld_multi  start <span class="sh_number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//1为实例编号</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysqld_multi  start <span class="sh_number">2</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# mysqld_multi  start 1		//1为实例编号
[root@mysql mysql]# mysqld_multi  start 2
</pre></div></div>
      <p>8）查看端口</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li> <span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># netstat <span class="sh_symbol">-</span>utnlp  <span class="sh_symbol">|</span> grep <span class="sh_symbol">:</span><span class="sh_number">3307</span></li><li>tcp6       <span class="sh_number">0</span>      <span class="sh_number">0</span> <span class="sh_symbol">:::</span><span class="sh_number">3307</span>                 <span class="sh_symbol">:::*</span>                    LISTEN      <span class="sh_number">21009</span><span class="sh_symbol">/</span>mysqld        </li><li> <span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># netstat <span class="sh_symbol">-</span>utnlp  <span class="sh_symbol">|</span> grep <span class="sh_symbol">:</span><span class="sh_number">3308</span></li><li>tcp6       <span class="sh_number">0</span>      <span class="sh_number">0</span> <span class="sh_symbol">:::</span><span class="sh_number">3308</span>                 <span class="sh_symbol">:::*</span>                    LISTEN      <span class="sh_number">21177</span><span class="sh_symbol">/</span>mysqld        </li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># ps <span class="sh_symbol">-</span>C mysqld</li><li>  PID TTY          TIME CMD</li><li><span class="sh_number">21009</span> <span class="sh_normal">pts</span><span class="sh_symbol">/</span><span class="sh_number">1</span>    <span class="sh_number">00</span><span class="sh_symbol">:</span><span class="sh_number">00</span><span class="sh_symbol">:</span><span class="sh_number">00</span> mysqld</li><li><span class="sh_number">21177</span> <span class="sh_normal">pts</span><span class="sh_symbol">/</span><span class="sh_number">1</span>    <span class="sh_number">00</span><span class="sh_symbol">:</span><span class="sh_number">00</span><span class="sh_symbol">:</span><span class="sh_number">00</span> mysqld</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;"> [root@mysql mysql]# netstat -utnlp  | grep :3307
tcp6       0      0 :::3307                 :::*                    LISTEN      21009/mysqld        
 [root@mysql mysql]# netstat -utnlp  | grep :3308
tcp6       0      0 :::3308                 :::*                    LISTEN      21177/mysqld        
[root@mysql mysql]# ps -C mysqld
  PID TTY          TIME CMD
21009 pts/1    00:00:00 mysqld
21177 pts/1    00:00:00 mysqld
</pre></div></div>
      <p>9）访问多实例</p>
      <p>使用初始化密码登录多实例1</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p<span class="sh_string">'7L?Vi!dGKmgu'</span> <span class="sh_symbol">-</span><span class="sh_normal">S </span><span class="sh_symbol">/</span><span class="sh_normal">data3307</span><span class="sh_symbol">/</span>mysqld<span class="sh_symbol">.</span>sock</li><li>mysql<span class="sh_symbol">&gt;</span> alter user root@<span class="sh_string">"localhost"</span>  identified by <span class="sh_string">'123456'</span><span class="sh_symbol">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改密码</span></li><li>mysql<span class="sh_symbol">&gt;</span> show databases<span class="sh_symbol">;</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> Database           <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> information_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> mysql              <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> performance_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> sys                <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_number">4</span> rows <span class="sh_keyword">in</span> <span class="sh_function">set</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]# mysql -u root -p'7L?Vi!dGKmgu' -S /data3307/mysqld.sock
mysql&gt; alter user root@"localhost"  identified by '123456';		//修改密码
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)
</pre></div></div>
      <p>使用初始化密码登录多实例2</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql bin<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p<span class="sh_string">'kC)BbyUp1a-b'</span> <span class="sh_symbol">-</span><span class="sh_normal">S </span><span class="sh_symbol">/</span><span class="sh_normal">data3307</span><span class="sh_symbol">/</span>mysqld<span class="sh_symbol">.</span>sock</li><li>mysql<span class="sh_symbol">&gt;</span> alter user root@<span class="sh_string">"localhost"</span>  identified by <span class="sh_string">'123456'</span><span class="sh_symbol">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//修改密码</span></li><li>mysql<span class="sh_symbol">&gt;</span> show databases<span class="sh_symbol">;</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> Database           <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> information_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> mysql              <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> performance_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> sys                <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_number">4</span> rows <span class="sh_keyword">in</span> <span class="sh_function">set</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql bin]# mysql -u root -p'kC)BbyUp1a-b' -S /data3307/mysqld.sock
mysql&gt; alter user root@"localhost"  identified by '123456';		//修改密码
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)
</pre></div></div>
      <p>10）创建库</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li>mysql<span class="sh_symbol">&gt;</span> create database db1<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">1</span> row <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> show databases<span class="sh_symbol">;</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> Database           <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_symbol">|</span> information_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> db1                <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> mysql              <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> performance_schema <span class="sh_symbol">|</span></li><li><span class="sh_symbol">|</span> sys                <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+--------------------+</span></li><li><span class="sh_number">5</span> rows <span class="sh_keyword">in</span> <span class="sh_function">set</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">mysql&gt; create database db1;
Query OK, 1 row affected (0.00 sec)
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| db1                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)
</pre></div></div>
      <p>11）停止启动的实例服务</p>
      <p>mysqld_multi --user=root  --password=密码  stop  实例编号</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span>#  mysqld_multi  <span class="sh_symbol">--</span>user<span class="sh_symbol">=</span>root  <span class="sh_symbol">--</span>password<span class="sh_symbol">=</span><span class="sh_number">123456</span> stop <span class="sh_number">1</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># netstat <span class="sh_symbol">-</span>utnlp <span class="sh_symbol">|</span> grep <span class="sh_symbol">:</span><span class="sh_number">3307</span>       <span class="sh_comment">//查看没有端口</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span>#  mysqld_multi  <span class="sh_symbol">--</span>user<span class="sh_symbol">=</span>root  <span class="sh_symbol">--</span>password<span class="sh_symbol">=</span><span class="sh_number">123456</span> stop <span class="sh_number">2</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># netstat <span class="sh_symbol">-</span>utnlp <span class="sh_symbol">|</span> grep <span class="sh_symbol">:</span><span class="sh_number">3308</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_comment">//查看没有端口</span></li><li><span class="sh_symbol">[</span>root@mysql mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>uroot   <span class="sh_symbol">-</span>p123456   <span class="sh_symbol">-</span><span class="sh_normal">S    </span><span class="sh_symbol">/</span><span class="sh_normal">data3307</span><span class="sh_symbol">/</span>mysqld<span class="sh_symbol">.</span>sock </li><li><span class="sh_comment">//拒绝连接</span></li><li>mysql<span class="sh_symbol">:</span> <span class="sh_symbol">[</span>Warning<span class="sh_symbol">]</span> Using a password on the command line <span class="sh_keyword">interface</span> can be insecure<span class="sh_symbol">.</span></li><li>ERROR <span class="sh_number">2002</span> <span class="sh_symbol">(</span>HY000<span class="sh_symbol">):</span> Can<span class="sh_string">'t connect to local MySQL server through socket '</span><span class="sh_regexp">/data3307/m</span>ysqld<span class="sh_symbol">.</span>sock<span class="sh_string">' (2)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mysql mysql]#  mysqld_multi  --user=root  --password=123456 stop 1
[root@mysql mysql]# netstat -utnlp | grep :3307       //查看没有端口
[root@mysql mysql]#  mysqld_multi  --user=root  --password=123456 stop 2
[root@mysql mysql]# netstat -utnlp | grep :3308		//查看没有端口
[root@mysql mysql]# mysql -uroot   -p123456   -S    /data3307/mysqld.sock 
//拒绝连接
mysql: [Warning] Using a password on the command line interface can be insecure.
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/data3307/mysqld.sock' (2)
</pre></div></div>
      <a name="case2">
      </a>
      <h2>2 案例2：准备MHA集群环境</h2>
      <h3>2.1 问题</h3>
      <ul class="list">
        <li>准备6台虚拟机，并按照本节规划配置好IP参数
</li>
        <li>在这些虚拟机之间实现SSH免密登录
</li>
        <li>在相应节点上安装好MHA相关的软件包
</li>
      </ul>
      <h3>2.2 方案</h3>
      <p>使用6台RHEL 7虚拟机，如图-1所示。准备集群环境，安装依赖包，授权用户，配置ssh密钥对认证登陆，所有节点之间互相以root秘钥对认证登录，管理主机以root密钥对认证登录所有数据节点主机，配置mha集群。</p>
      <div class="image">
        <img src="./day03CASE_files/image001.png">
        <p>图－1</p>
      </div>
      <p>IP规划，如图-2所示：</p>
      <div class="image">
        <img src="./day03CASE_files/image002.png">
        <p>图-2</p>
      </div>
      <h3>2.3 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一： 准备集群环境</p>
      <p>1）修改主机名，配置IP（其余几台请按照图-2修改IP和主机名，这里以master51为例）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># echo master51  <span class="sh_symbol">&gt;</span> <span class="sh_regexp">/etc/</span>hostname</li><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># nmcli connection modify eth0  ipv4<span class="sh_symbol">.</span>method manual   ipv4<span class="sh_symbol">.</span>addresses <span class="sh_number">192.168.4.51</span><span class="sh_symbol">/</span><span class="sh_number">24</span> connection<span class="sh_symbol">.</span>autoconnect yes</li><li><span class="sh_symbol">[</span>root@localhost <span class="sh_symbol">~]</span># nmcli connection up eth0</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@localhost ~]# echo master51  &gt; /etc/hostname
[root@localhost ~]# nmcli connection modify eth0  ipv4.method manual   ipv4.addresses 192.168.4.51/24 connection.autoconnect yes
[root@localhost ~]# nmcli connection up eth0
</pre></div></div>
      <p>2在所有主机上安装Perl依赖包（51-56操作）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master51 <span class="sh_symbol">~]</span># cd <span class="sh_normal">mysql</span><span class="sh_symbol">/</span>mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span><span class="sh_normal">student</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@master51 <span class="sh_symbol">~]</span># yum <span class="sh_symbol">-</span>y install  perl<span class="sh_symbol">-*.</span>rpm</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master51 ~]# cd mysql/mha-soft-student/
[root@master51 ~]# yum -y install  perl-*.rpm

</pre></div></div>
      <p>3）在所有数据库服务器上安装mha-node包（51-55操作）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master51 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># yum  <span class="sh_symbol">-</span>y  install  perl<span class="sh_symbol">-</span>DBD<span class="sh_symbol">-</span>mysql  perl<span class="sh_symbol">-</span>DBI</li><li> <span class="sh_symbol">[</span>root@master51 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># rpm <span class="sh_symbol">-</span>ivh mha4mysql<span class="sh_symbol">-</span>node<span class="sh_number">-0.56-0</span><span class="sh_symbol">.</span>el6<span class="sh_symbol">.</span>noarch<span class="sh_symbol">.</span>rpm</li><li>Preparing<span class="sh_symbol">...</span>                          ################################# <span class="sh_symbol">[</span><span class="sh_number">100</span><span class="sh_symbol">%]</span></li><li><span class="sh_normal">Updating </span><span class="sh_symbol">/</span> installing<span class="sh_symbol">...</span></li><li>   <span class="sh_number">1</span><span class="sh_symbol">:</span>mha4mysql<span class="sh_symbol">-</span>node<span class="sh_number">-0.56-0</span><span class="sh_symbol">.</span>el6        ################################# <span class="sh_symbol">[</span><span class="sh_number">100</span><span class="sh_symbol">%]</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master51 mha-soft-student]# yum  -y  install  perl-DBD-mysql  perl-DBI
 [root@master51 mha-soft-student]# rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm
Preparing...                          ################################# [100%]
Updating / installing...
   1:mha4mysql-node-0.56-0.el6        ################################# [100%]

</pre></div></div>
      <p>4）在管理主机上安装mha_node 和 mha-manager包（56操作）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mgm56 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># yum <span class="sh_symbol">-</span>y  install perl<span class="sh_symbol">-</span>DBD<span class="sh_symbol">-</span>mysql   perl<span class="sh_symbol">-</span>DBI</li><li><span class="sh_symbol">[</span>root@mgm56 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># rpm <span class="sh_symbol">-</span>ivh  mha4mysql<span class="sh_symbol">-</span>node<span class="sh_number">-0.56-0</span><span class="sh_symbol">.</span>el6<span class="sh_symbol">.</span>noarch<span class="sh_symbol">.</span>rpm</li><li>Preparing<span class="sh_symbol">...</span>                          ################################# <span class="sh_symbol">[</span><span class="sh_number">100</span><span class="sh_symbol">%]</span></li><li><span class="sh_normal">Updating </span><span class="sh_symbol">/</span> installing<span class="sh_symbol">...</span></li><li>   <span class="sh_number">1</span><span class="sh_symbol">:</span>mha4mysql<span class="sh_symbol">-</span>node<span class="sh_number">-0.56-0</span><span class="sh_symbol">.</span>el6        ################################# <span class="sh_symbol">[</span><span class="sh_number">100</span><span class="sh_symbol">%]</span></li><li><span class="sh_symbol">[</span>root@mgm56 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># yum <span class="sh_symbol">-</span>y  install perl<span class="sh_symbol">-</span>ExtUtils<span class="sh_symbol">-*</span>   perl<span class="sh_symbol">-</span>CPAN<span class="sh_symbol">-*</span></li><li><span class="sh_symbol">[</span>root@mgm56 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># tar <span class="sh_symbol">-</span>zxf mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">.</span>tar<span class="sh_symbol">.</span>gz</li><li><span class="sh_symbol">[</span>root@mgm56 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># cd mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span># perl  Makefile<span class="sh_symbol">.</span>PL</li><li><span class="sh_symbol">***</span> Module<span class="sh_symbol">::</span>AutoInstall version <span class="sh_number">1.03</span></li><li><span class="sh_symbol">***</span> Checking <span class="sh_keyword">for</span> Perl dependencies<span class="sh_symbol">...</span></li><li><span class="sh_symbol">[</span>Core Features<span class="sh_symbol">]</span></li><li><span class="sh_symbol">-</span> DBI                   <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">1.627</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> DBD<span class="sh_symbol">::</span>mysql            <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">4.023</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> Time<span class="sh_symbol">::</span>HiRes           <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">1.9725</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> Config<span class="sh_symbol">::</span>Tiny          <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">2.14</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> Log<span class="sh_symbol">::</span>Dispatch         <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">2.41</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> Parallel<span class="sh_symbol">::</span>ForkManager <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">1.18</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">-</span> MHA<span class="sh_symbol">::</span>NodeConst        <span class="sh_symbol">...</span>loaded<span class="sh_symbol">.</span> <span class="sh_symbol">(</span><span class="sh_number">0.56</span><span class="sh_symbol">)</span></li><li><span class="sh_symbol">***</span> Module<span class="sh_symbol">::</span>AutoInstall configuration finished<span class="sh_symbol">.</span>   <span class="sh_comment">//配置完成</span></li><li>Checking <span class="sh_keyword">if</span> your kit is complete<span class="sh_symbol">...</span></li><li>Looks good</li><li>Writing Makefile <span class="sh_keyword">for</span> mha4mysql<span class="sh_symbol">::</span>manager</li><li>Writing MYMETA<span class="sh_symbol">.</span>yml and MYMETA<span class="sh_symbol">.</span>json</li><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span># make</li><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span># make  install</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mgm56 mha-soft-student]# yum -y  install perl-DBD-mysql   perl-DBI
[root@mgm56 mha-soft-student]# rpm -ivh  mha4mysql-node-0.56-0.el6.noarch.rpm
Preparing...                          ################################# [100%]
Updating / installing...
   1:mha4mysql-node-0.56-0.el6        ################################# [100%]
[root@mgm56 mha-soft-student]# yum -y  install perl-ExtUtils-*   perl-CPAN-*
[root@mgm56 mha-soft-student]# tar -zxf mha4mysql-manager-0.56.tar.gz
[root@mgm56 mha-soft-student]# cd mha4mysql-manager-0.56/
[root@mgm56 mha4mysql-manager-0.56]# perl  Makefile.PL
*** Module::AutoInstall version 1.03
*** Checking for Perl dependencies...
[Core Features]
- DBI                   ...loaded. (1.627)
- DBD::mysql            ...loaded. (4.023)
- Time::HiRes           ...loaded. (1.9725)
- Config::Tiny          ...loaded. (2.14)
- Log::Dispatch         ...loaded. (2.41)
- Parallel::ForkManager ...loaded. (1.18)
- MHA::NodeConst        ...loaded. (0.56)
*** Module::AutoInstall configuration finished.   //配置完成
Checking if your kit is complete...
Looks good
Writing Makefile for mha4mysql::manager
Writing MYMETA.yml and MYMETA.json
[root@mgm56 mha4mysql-manager-0.56]# make
[root@mgm56 mha4mysql-manager-0.56]# make  install

</pre></div></div>
      <p class="number">步骤二： 配置ssh密钥对认证登陆</p>
      <p>1）所有节点之间可以互相以ssh密钥对方式认证登陆以（以51为例）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master51 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># ssh<span class="sh_symbol">-</span>keygen</li><li><span class="sh_symbol">[</span>root@master51 mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span>student<span class="sh_symbol">]</span># ssh<span class="sh_symbol">-</span>copy<span class="sh_symbol">-</span>id  <span class="sh_number">192.168.4.52</span> </li><li><span class="sh_comment">//除了传给52外，53，54，55也要传，52-55主机也是一样的</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master51 mha-soft-student]# ssh-keygen
[root@master51 mha-soft-student]# ssh-copy-id  192.168.4.52 
//除了传给52外，53，54，55也要传，52-55主机也是一样的
</pre></div></div>
      <p>6）配置56主机 无密码ssh登录所有数据节点主机</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span># ssh<span class="sh_symbol">-</span>keygen</li><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span># ssh<span class="sh_symbol">-</span>copy<span class="sh_symbol">-</span>id  <span class="sh_number">192.168.4.51</span>   </li><li><span class="sh_comment">//除传给51外，还要传给52-55 </span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mgm56 mha4mysql-manager-0.56]# ssh-keygen
[root@mgm56 mha4mysql-manager-0.56]# ssh-copy-id  192.168.4.51   
//除传给51外，还要传给52-55 


</pre></div></div>
      <a name="case3">
      </a>
      <h2>3 案例3：配置MHA集群环境</h2>
      <h3>3.1 问题</h3>
      <ul class="list">
        <li>配置主节点 master51
</li>
        <li>配置两个备用主节点 master52、master53
</li>
        <li>配置两个从节点 slave54、slave55
</li>
        <li>配置管理节点 mgm56
</li>
      </ul>
      <ol class="list">
        <li>
</li>
      </ol>
      <h3>3.2 步骤</h3>
      <p>实现此案例需要按照如下步骤进行。</p>
      <p class="number">步骤一：配置mha集群环境</p>
      <p>1）安装数据库（51-55同样操作，以51为例）</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master51 <span class="sh_symbol">~]</span># <span class="sh_normal">cd </span><span class="sh_symbol">/</span><span class="sh_normal">root</span><span class="sh_symbol">/</span>mysql</li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># tar <span class="sh_symbol">-</span>xf mysql<span class="sh_number">-5.7.17</span><span class="sh_symbol">.</span>tar</li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># yum <span class="sh_symbol">-</span>y install perl<span class="sh_symbol">-</span>JSON</li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># rpm <span class="sh_symbol">-</span>Uvh mysql<span class="sh_symbol">-</span>community<span class="sh_symbol">-*.</span>rpm</li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># rpm <span class="sh_symbol">-</span>qa <span class="sh_symbol">|</span> grep  <span class="sh_symbol">-</span>i mysql</li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master51 ~]# cd /root/mysql
[root@master51 mysql]# tar -xf mysql-5.7.17.tar
[root@master51 mysql]# yum -y install perl-JSON
[root@master51 mysql]# rpm -Uvh mysql-community-*.rpm
[root@master51 mysql]# rpm -qa | grep  -i mysql

</pre></div></div>
      <p>2）master51 数据库服务器配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>my<span class="sh_symbol">.</span>cnf</li><li>plugin<span class="sh_symbol">-</span>load <span class="sh_symbol">=</span> <span class="sh_string">"rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>master<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>slave<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>server_id<span class="sh_symbol">=</span><span class="sh_number">51</span></li><li>log<span class="sh_symbol">-</span>bin<span class="sh_symbol">=</span>master51</li><li>binlog<span class="sh_symbol">-</span>format<span class="sh_symbol">=</span><span class="sh_string">"mixed"</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># systemctl  restart  mysqld</li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@master51 mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p123456</li><li><span style="display:none;">&nbsp;</span></li><li>mysql<span class="sh_symbol">&gt;</span> set  global  relay_log_purge<span class="sh_symbol">=</span>off<span class="sh_symbol">;</span>  <span class="sh_comment">//不自动删除本机的中继日志文件</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li><span style="display:none;">&nbsp;</span></li><li>mysql<span class="sh_symbol">&gt;</span>  grant  replication slave  on  <span class="sh_symbol">*.*</span>  to repluser@<span class="sh_string">"%"</span>  identified by <span class="sh_string">"123456"</span><span class="sh_symbol">;</span></li><li><span class="sh_comment">//添加主从同步授权用户</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows affected<span class="sh_symbol">,</span> <span class="sh_number">1</span> <span class="sh_function">warning</span> <span class="sh_symbol">(</span><span class="sh_number">10.01</span> sec<span class="sh_symbol">)</span></li><li><span style="display:none;">&nbsp;</span></li><li>mysql<span class="sh_symbol">&gt;</span> show master status<span class="sh_symbol">;</span></li><li><span class="sh_symbol">+-----------------+----------+--------------+------------------+-------------+</span></li><li><span class="sh_symbol">|</span> File            <span class="sh_symbol">|</span> Position <span class="sh_symbol">|</span> Binlog_Do_DB <span class="sh_symbol">|</span> Binlog_Ignore_DB <span class="sh_symbol">|</span> Executed_Gtid_Set <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+-----------------+----------+--------------+------------------+--------------+</span></li><li><span class="sh_symbol">|</span> master51<span class="sh_number">.000003</span> <span class="sh_symbol">|</span>      <span class="sh_number">441</span> <span class="sh_symbol">|</span>              <span class="sh_symbol">|</span>                  <span class="sh_symbol">|</span>                   <span class="sh_symbol">|</span></li><li><span class="sh_symbol">+-----------------+----------+--------------+------------------+--------------+</span></li><li><span class="sh_number">1</span> row <span class="sh_keyword">in</span> <span class="sh_function">set</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master51 mysql]# vim /etc/my.cnf
plugin-load = "rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
rpl-semi-sync-master-enabled = 1
rpl-semi-sync-slave-enabled = 1
server_id=51
log-bin=master51
binlog-format="mixed"

[root@master51 mysql]# systemctl  restart  mysqld

[root@master51 mysql]# mysql -u root -p123456

mysql&gt; set  global  relay_log_purge=off;  //不自动删除本机的中继日志文件
Query OK, 0 rows affected (0.00 sec)

mysql&gt;  grant  replication slave  on  *.*  to repluser@"%"  identified by "123456";
//添加主从同步授权用户
Query OK, 0 rows affected, 1 warning (10.01 sec)

mysql&gt; show master status;
+-----------------+----------+--------------+------------------+-------------+
| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+-----------------+----------+--------------+------------------+--------------+
| master51.000003 |      441 |              |                  |                   |
+-----------------+----------+--------------+------------------+--------------+
1 row in set (0.00 sec)
</pre></div></div>
      <p>3）master52数据库服务器配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master52 mysql<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>my<span class="sh_symbol">.</span>cnf</li><li>plugin<span class="sh_symbol">-</span>load <span class="sh_symbol">=</span><span class="sh_string">"rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>master<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>slave<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>server_id<span class="sh_symbol">=</span><span class="sh_number">52</span></li><li>log<span class="sh_symbol">-</span>bin<span class="sh_symbol">=</span>master52</li><li>binlog<span class="sh_symbol">-</span>format<span class="sh_symbol">=</span><span class="sh_string">"mixed"</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@master52 mysql<span class="sh_symbol">]</span># systemctl  restart  mysqld</li><li><span class="sh_symbol">[</span>root@master52 mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p123456</li><li>mysql<span class="sh_symbol">&gt;</span> set  global  relay_log_purge<span class="sh_symbol">=</span>off<span class="sh_symbol">;</span></li><li>mysql<span class="sh_symbol">&gt;</span> change master to </li><li>    <span class="sh_symbol">-&gt;</span> master_host<span class="sh_symbol">=</span><span class="sh_string">"192.168.4.51"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_user<span class="sh_symbol">=</span><span class="sh_string">"repluser"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_password<span class="sh_symbol">=</span><span class="sh_string">"123456"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_log_file<span class="sh_symbol">=</span><span class="sh_string">"master51.000003"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_log_pos<span class="sh_symbol">=</span><span class="sh_number">441</span><span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows affected<span class="sh_symbol">,</span> <span class="sh_number">2</span> <span class="sh_function">warnings</span> <span class="sh_symbol">(</span><span class="sh_number">0.01</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> start slave<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.01</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> show slave status<span class="sh_symbol">\</span>G<span class="sh_symbol">;</span></li><li><span class="sh_symbol">...</span></li><li>             Slave_IO_Running<span class="sh_symbol">:</span> Yes</li><li>            Slave_SQL_Running<span class="sh_symbol">:</span> Yes</li><li><span class="sh_symbol">...</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master52 mysql]# vim /etc/my.cnf
plugin-load ="rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
rpl-semi-sync-master-enabled = 1
rpl-semi-sync-slave-enabled = 1
server_id=52
log-bin=master52
binlog-format="mixed"

[root@master52 mysql]# systemctl  restart  mysqld
[root@master52 mysql]# mysql -u root -p123456
mysql&gt; set  global  relay_log_purge=off;
mysql&gt; change master to 
    -&gt; master_host="192.168.4.51",
    -&gt; master_user="repluser",
    -&gt; master_password="123456",
    -&gt; master_log_file="master51.000003",
    -&gt; master_log_pos=441;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
mysql&gt; start slave;
Query OK, 0 rows affected (0.01 sec)
mysql&gt; show slave status\G;
...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...
</pre></div></div>
      <p>4）master53数据库服务器配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@master53 mysql<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>my<span class="sh_symbol">.</span>cnf</li><li>plugin<span class="sh_symbol">-</span>load <span class="sh_symbol">=</span><span class="sh_string">"rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>master<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>rpl<span class="sh_symbol">-</span>semi<span class="sh_symbol">-</span>sync<span class="sh_symbol">-</span>slave<span class="sh_symbol">-</span>enabled <span class="sh_symbol">=</span> <span class="sh_number">1</span></li><li>server_id<span class="sh_symbol">=</span><span class="sh_number">53</span></li><li>log<span class="sh_symbol">-</span>bin<span class="sh_symbol">=</span>master53</li><li>binlog<span class="sh_symbol">-</span>format<span class="sh_symbol">=</span><span class="sh_string">"mixed"</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@master53 mysql<span class="sh_symbol">]</span># systemctl  restart  mysqld</li><li><span class="sh_symbol">[</span>root@master53 mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p123456</li><li>mysql<span class="sh_symbol">&gt;</span>  set  global  relay_log_purge<span class="sh_symbol">=</span>off<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li><span style="display:none;">&nbsp;</span></li><li>mysql<span class="sh_symbol">&gt;</span> change master to</li><li>    <span class="sh_symbol">-&gt;</span> master_host<span class="sh_symbol">=</span><span class="sh_string">"192.168.4.51"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_user<span class="sh_symbol">=</span><span class="sh_string">"repluser"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_password<span class="sh_symbol">=</span><span class="sh_string">"123456"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_log_file<span class="sh_symbol">=</span><span class="sh_string">"master51.000003"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_log_pos<span class="sh_symbol">=</span><span class="sh_number">441</span><span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows affected<span class="sh_symbol">,</span> <span class="sh_number">2</span> <span class="sh_function">warnings</span> <span class="sh_symbol">(</span><span class="sh_number">0.01</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> start slave<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> show slave status<span class="sh_symbol">\</span>G<span class="sh_symbol">;</span></li><li><span class="sh_symbol">...</span></li><li>             Slave_IO_Running<span class="sh_symbol">:</span> Yes</li><li>            Slave_SQL_Running<span class="sh_symbol">:</span> Yes</li><li><span class="sh_symbol">...</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@master53 mysql]# vim /etc/my.cnf
plugin-load ="rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so"
rpl-semi-sync-master-enabled = 1
rpl-semi-sync-slave-enabled = 1
server_id=53
log-bin=master53
binlog-format="mixed"

[root@master53 mysql]# systemctl  restart  mysqld
[root@master53 mysql]# mysql -u root -p123456
mysql&gt;  set  global  relay_log_purge=off;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; change master to
    -&gt; master_host="192.168.4.51",
    -&gt; master_user="repluser",
    -&gt;  master_password="123456",
    -&gt; master_log_file="master51.000003",
    -&gt;  master_log_pos=441;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; show slave status\G;
...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...

</pre></div></div>
      <p>5）slave54 数据库服务器配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@slave54 mysql<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>my<span class="sh_symbol">.</span>cnf</li><li>server_id<span class="sh_symbol">=</span><span class="sh_number">54</span></li><li><span class="sh_symbol">[</span>root@master54 mysql<span class="sh_symbol">]</span># systemctl  restart  mysqld</li><li><span class="sh_symbol">[</span>root@master54 mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p123456</li><li>mysql<span class="sh_symbol">&gt;</span> change master to</li><li>    <span class="sh_symbol">-&gt;</span> master_host<span class="sh_symbol">=</span><span class="sh_string">"192.168.4.51"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_user<span class="sh_symbol">=</span><span class="sh_string">"repluser"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_password<span class="sh_symbol">=</span><span class="sh_string">"123456"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_log_file<span class="sh_symbol">=</span><span class="sh_string">"master51.000003"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_log_pos<span class="sh_symbol">=</span><span class="sh_number">441</span><span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows affected<span class="sh_symbol">,</span> <span class="sh_number">2</span> <span class="sh_function">warnings</span> <span class="sh_symbol">(</span><span class="sh_number">0.01</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> start slave<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> show slave status<span class="sh_symbol">\</span>G<span class="sh_symbol">;</span></li><li><span class="sh_symbol">...</span></li><li>             Slave_IO_Running<span class="sh_symbol">:</span> Yes</li><li>            Slave_SQL_Running<span class="sh_symbol">:</span> Yes</li><li><span class="sh_symbol">...</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@slave54 mysql]# vim /etc/my.cnf
server_id=54
[root@master54 mysql]# systemctl  restart  mysqld
[root@master54 mysql]# mysql -u root -p123456
mysql&gt; change master to
    -&gt; master_host="192.168.4.51",
    -&gt; master_user="repluser",
    -&gt;  master_password="123456",
    -&gt; master_log_file="master51.000003",
    -&gt;  master_log_pos=441;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; show slave status\G;
...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...
</pre></div></div>
      <p>6）slave55 数据库服务器配置文件</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@slave55 mysql<span class="sh_symbol">]</span># <span class="sh_normal">vim </span><span class="sh_symbol">/</span><span class="sh_normal">etc</span><span class="sh_symbol">/</span>my<span class="sh_symbol">.</span>cnf</li><li>server_id<span class="sh_symbol">=</span><span class="sh_number">55</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_symbol">[</span>root@master55 mysql<span class="sh_symbol">]</span># systemctl  restart  mysqld</li><li><span class="sh_symbol">[</span>root@master55 mysql<span class="sh_symbol">]</span># mysql <span class="sh_symbol">-</span>u root <span class="sh_symbol">-</span>p123456</li><li>mysql<span class="sh_symbol">&gt;</span> change master to</li><li>    <span class="sh_symbol">-&gt;</span> master_host<span class="sh_symbol">=</span><span class="sh_string">"192.168.4.51"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_user<span class="sh_symbol">=</span><span class="sh_string">"repluser"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_password<span class="sh_symbol">=</span><span class="sh_string">"123456"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span> master_log_file<span class="sh_symbol">=</span><span class="sh_string">"master51.000003"</span><span class="sh_symbol">,</span></li><li>    <span class="sh_symbol">-&gt;</span>  master_log_pos<span class="sh_symbol">=</span><span class="sh_number">441</span><span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows affected<span class="sh_symbol">,</span> <span class="sh_number">2</span> <span class="sh_function">warnings</span> <span class="sh_symbol">(</span><span class="sh_number">0.01</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> start slave<span class="sh_symbol">;</span></li><li>Query OK<span class="sh_symbol">,</span> <span class="sh_number">0</span> rows <span class="sh_function">affected</span> <span class="sh_symbol">(</span><span class="sh_number">0.00</span> sec<span class="sh_symbol">)</span></li><li>mysql<span class="sh_symbol">&gt;</span> show slave status<span class="sh_symbol">\</span>G<span class="sh_symbol">;</span></li><li><span class="sh_symbol">...</span></li><li>             Slave_IO_Running<span class="sh_symbol">:</span> Yes</li><li>            Slave_SQL_Running<span class="sh_symbol">:</span> Yes</li><li><span class="sh_symbol">...</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@slave55 mysql]# vim /etc/my.cnf
server_id=55

[root@master55 mysql]# systemctl  restart  mysqld
[root@master55 mysql]# mysql -u root -p123456
mysql&gt; change master to
    -&gt; master_host="192.168.4.51",
    -&gt; master_user="repluser",
    -&gt;  master_password="123456",
    -&gt; master_log_file="master51.000003",
    -&gt;  master_log_pos=441;
Query OK, 0 rows affected, 2 warnings (0.01 sec)
mysql&gt; start slave;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; show slave status\G;
...
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
...

</pre></div></div>
      <p>7）配置管理主机4.56</p>
      <div class="snippet-container" style="undefined;"><div class="sh_acid snippet-wrap"><div class="snippet-menu sh_sourceCode" style="display:none;"><pre style="display: none;"><a class="snippet-copy sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#" style="display: none;">copy</a><a class="snippet-text sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">text</a><a class="snippet-window sh_url" href="http://tts.tmooc.cn/ttsPage/VIP/NSDVN201805/DBA2/DAY03/CASE/01/index.html#">pop-up</a></pre></div><pre class="code sh_javascript snippet-formatted sh_sourceCode"><ol class="snippet-num"><li><span class="sh_symbol">[</span>root@mgm56 <span class="sh_symbol">~]</span># cd <span class="sh_normal">mysql</span><span class="sh_symbol">/</span>mha<span class="sh_symbol">-</span>soft<span class="sh_symbol">-</span><span class="sh_normal">student</span><span class="sh_symbol">/</span>mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">/</span></li><li><span class="sh_symbol">[</span>root@mgm56 mha4mysql<span class="sh_symbol">-</span>manager<span class="sh_number">-0.56</span><span class="sh_symbol">]</span>#  cp bin<span class="sh_comment">/* /usr/local/bin/  </span></li><li><span class="sh_comment">//提示覆盖，说明安装的时候有，没有可以拷贝过来</span></li><li><span class="sh_comment">[</span><a class="sh_url" href="mailto:root@mgm56">root@mgm56</a><span class="sh_comment"> mha4mysql-manager-0.56]# mkdir /etc/mha_manager&nbsp;&nbsp;&nbsp;&nbsp;//创建工作目录</span></li><li><span class="sh_comment">[</span><a class="sh_url" href="mailto:root@mgm56">root@mgm56</a><span class="sh_comment"> mha4mysql-manager-0.56]#  cp samples/conf/app1.cnf  /etc/mha_manager</span></li><li><span class="sh_comment">//建立样板文件 </span></li><li><span class="sh_comment">[</span><a class="sh_url" href="mailto:root@mgm56">root@mgm56</a><span class="sh_comment"> mha4mysql-manager-0.56]# vim /etc/mha_manager/app1.cnf </span></li><li><span class="sh_comment">//编辑主配置文件app1.cnf</span></li><li><span class="sh_comment">[server default]</span></li><li><span class="sh_comment">manager_workdir=/etc/mha_manager</span></li><li><span class="sh_comment">manager_log=/etc/mha_manager/manager.log</span></li><li><span class="sh_comment">master_ip_failover_script=/usr/local/bin/master_ip_failover</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">ssh_user=root</span></li><li><span class="sh_comment">ssh_port=22</span></li><li><span class="sh_comment">repl_user=repluser</span></li><li><span class="sh_comment">repl_password=123456</span></li><li><span class="sh_comment">user=root</span></li><li><span class="sh_comment">password=123456</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">[server1]</span></li><li><span class="sh_comment">hostname=192.168.4.51    </span></li><li><span class="sh_comment">port=3306</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">[server2]</span></li><li><span class="sh_comment">hostname=192.168.4.52</span></li><li><span class="sh_comment">port=3306            </span></li><li><span class="sh_comment">candidate_master=1</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">[server3]</span></li><li><span class="sh_comment">hostname=192.168.4.53</span></li><li><span class="sh_comment">port=3306</span></li><li><span class="sh_comment">candidate_master=1</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">[server4]</span></li><li><span class="sh_comment">hostname=192.168.4.54</span></li><li><span class="sh_comment">no_master=1</span></li><li><span style="display:none;">&nbsp;</span></li><li><span class="sh_comment">[server5]</span></li><li><span class="sh_comment">hostname=192.168.4.55</span></li><li><span class="sh_comment">no_master=1</span></li><li><span class="sh_comment"> [</span><a class="sh_url" href="mailto:root@mgm56">root@mgm56</a><span class="sh_comment"> mha4mysql-manager-0.56]# cp samples/scripts/master_ip_failover </span></li><li><span class="sh_comment">  /usr/local/bin/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//创建故障切换的脚本</span></li></ol></pre><pre class="snippet-textonly sh_sourceCode" style="display:none;">[root@mgm56 ~]# cd mysql/mha-soft-student/mha4mysql-manager-0.56/
[root@mgm56 mha4mysql-manager-0.56]#  cp bin/* /usr/local/bin/  
//提示覆盖，说明安装的时候有，没有可以拷贝过来
[root@mgm56 mha4mysql-manager-0.56]# mkdir /etc/mha_manager	//创建工作目录
[root@mgm56 mha4mysql-manager-0.56]#  cp samples/conf/app1.cnf  /etc/mha_manager
//建立样板文件 
[root@mgm56 mha4mysql-manager-0.56]# vim /etc/mha_manager/app1.cnf 
//编辑主配置文件app1.cnf
[server default]
manager_workdir=/etc/mha_manager
manager_log=/etc/mha_manager/manager.log
master_ip_failover_script=/usr/local/bin/master_ip_failover

ssh_user=root
ssh_port=22
repl_user=repluser
repl_password=123456
user=root
password=123456

[server1]
hostname=192.168.4.51    
port=3306

[server2]
hostname=192.168.4.52
port=3306            
candidate_master=1

[server3]
hostname=192.168.4.53
port=3306
candidate_master=1

[server4]
hostname=192.168.4.54
no_master=1

[server5]
hostname=192.168.4.55
no_master=1
 [root@mgm56 mha4mysql-manager-0.56]# cp samples/scripts/master_ip_failover 
  /usr/local/bin/		//创建故障切换的脚本
</pre></div></div>
    </div>
  
</body></html>